<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy M√°gikus F≈ëz√©srendszer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
            nav{
            left:25px;
            text-align: center;
            position: fixed;
            top: 0;
            width: 98%;
            background-color:#071f4a;
            padding: 1px;
            border-radius: 14px;
            
            }

            nav ul {
            list-style: none;
            padding-left: 0;
            }
            nav ul li {
            margin: 0.5rem 0;
            display: inline;
            padding: 20px;
            font-weight: 900;
            font-size:20px;
            }

            nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            }
            nav ul li a:hover {
            text-decoration: underline;
            }





        #cook-recipe-select{
            background-color: #22273f;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(to bottom, #1a2238, #364560);
            color: gray;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }

        .panel {
            width: 450px;
            background: #071f4a;
            border: 3px double #80b3ff;
            border-radius: 10px;
            padding: 20px;
            
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .panel h2 {
            color: #fff;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            border-bottom: 2px solid #fff;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #fff;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #80b3ff;
            border-radius: 5px;
            background: rgba(139, 69, 19, 0.2);
            color: #e8d5b7;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        button {
            background: linear-gradient(135deg, #80b3ff 0%, #071f4a 100%);
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
            border: 1px solid #654321;
        }

        button:hover {
            background: linear-gradient(135deg, #071f4a 0%, #80b3ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .item-list {
            width: 400px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #80b3ff;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.2);
        }

        .item {
            padding: 10px;
            border-bottom: 1px solid #80b3ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item:hover {
            background: rgba(139, 69, 19, 0.3);
        }

        .rarity-common { color: #ffffff; }
        .rarity-rare { color: #0080ff; }
        .rarity-legendary { color: #ff8000; }

        .recipe-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #80b3ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .recipe-title {
            color: #fff;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .buff-card {
            background: rgba(0, 100, 0, 0.2);
            border: 1px solid #228b22;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .buff-expired {
            background: rgba(100, 0, 0, 0.2);
            border-color: #8b2222;
        }

        .cooking-simulation {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .dice-result {
            font-size: 2em;
            color: #fff;
            margin: 10px 0;
        }

        .success { color: #00ff00; }
        .failure { color: #ff0000; }
        .critical { color: #ff8000; text-shadow: 0 0 10px currentColor; }

        .search-box {
            margin-bottom: 15px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: rgba(139, 69, 19, 0.2);
            border: 1px solid #80b3ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255, 215, 0, 0.2);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;

        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin: 0 4px;
        }

        .badge-common { background: #6b7280; color: white; }
        .badge-rare { background: #3b82f6; color: white; }
        .badge-legendary { background: #f97316; color: white; }
        .badge-outline { border: 1px solid #fff; color: #fff; background: transparent; }

        .btn-destructive { background: #dc2626; }
        .btn-destructive:hover { background: #b91c1c; }

        .btn-green { background: #16a34a; }
        .btn-green:hover { background: #15803d; }

        .btn-blue { background: #2563eb; }
        .btn-blue:hover { background: #1d4ed8; }

        .btn-purple { background: #7c3aed; }
        .btn-purple:hover { background: #6d28d9; }

        .btn-orange { background: #ea580c; }
        .btn-orange:hover { background: #c2410c; }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                height: auto;
            }
        }
    </style>
</head>
<body>

    <nav id="nav">
        <ul>
            <li><a href="clock.html">time</a>
            <li><a href="nagy t√©rk√©p.html">big map</a>
            <li><a href="\carft\index.html">crafting</a>
            <li><a href="browing.html">brewing</a></li>
        </ul>
    </nav>


    <div class="container">
        <!-- Bal panel: Hozz√°val√≥k -->
        <div class="panel">
            <h2>üß™ Hozz√°val√≥k</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('ingredients', 'list')">Lista</div>
                <div class="tab" onclick="switchTab('ingredients', 'add')">Hozz√°ad√°s</div>
            </div>

            <div id="ingredients-list" class="tab-content active">
                <div class="search-box">
                    <input type="text" id="ingredient-search" placeholder="Keres√©s..." onkeyup="searchIngredients()">
                </div>
                <div class="form-group">
                    <select id="rarity-filter" onchange="filterIngredients()">
                        <option value="all">Minden ritkas√°g</option>
                        <option value="common">Gyakori</option>
                        <option value="rare">Ritka</option>
                        <option value="legendary">Legend√°s</option>
                    </select>
                </div>
                <div id="ingredients-container" class="item-list"></div>
            </div>

            <div id="ingredients-add" class="tab-content">
                <div class="form-group">
                    <label>N√©v:</label>
                    <input type="text" id="new-ingredient-name">
                </div>
                <div class="form-group">
                    <label>Ritkas√°g:</label>
                    <select id="new-ingredient-rarity">
                        <option value="common">Gyakori</option>
                        <option value="rare">Ritka</option>
                        <option value="legendary">Legend√°s</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Le√≠r√°s:</label>
                    <textarea id="new-ingredient-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Mennyis√©g:</label>
                    <input type="number" id="new-ingredient-quantity" min="1" value="1">
                </div>
                <button onclick="addIngredient()" class="btn-green">Hozz√°val√≥ hozz√°ad√°sa</button>
            </div>
        </div>

        <!-- K√∂z√©ps≈ë panel: Receptek -->
        <div class="panel">
            <h2>üìú Receptek & F≈ëz√©s</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('recipes', 'list')">Receptek</div>
                <div class="tab" onclick="switchTab('recipes', 'add')">√öj recept</div>
                <div class="tab" onclick="switchTab('recipes', 'cook')">F≈ëz√©s</div>
            </div>

            <div id="recipes-list" class="tab-content active">
                <div class="search-box">
                    <input type="text" id="recipe-search" placeholder="Recept keres√©se..." onkeyup="searchRecipes()">
                </div>
                <div id="recipes-container"></div>
            </div>

            <div id="recipes-add" class="tab-content">
                <div class="form-group">
                    <label>Recept neve:</label>
                    <input type="text" id="new-recipe-name">
                </div>
                <div class="form-group">
                    <label>Hozz√°val√≥k (min. 3 darab √∂sszesen):</label>
                    <div id="selected-ingredients"></div>
                    <div id="available-ingredients"></div>
                </div>
                <div class="form-group">
                    <label>F≈ëz√©si m√≥d:</label>
                    <select id="new-recipe-method">
                        <option value="campfire">T√°bori t≈±z</option>
                        <option value="wanderer">V√°ndorkonyha</option>
                        <option value="sanctuary">Szent√©lykonyha</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Buff hat√°s:</label>
                    <input type="text" id="new-recipe-buff" placeholder="pl. +2 Er≈ë, +1 √úgyess√©g">
                </div>
                <div class="form-group">
                    <label>Hat√°startam (napok):</label>
                    <input type="number" id="new-recipe-duration" min="1" max="3" value="1">
                </div>
                <div class="form-group">
                    <label>Neh√©zs√©g (DC):</label>
                    <input type="number" id="new-recipe-difficulty" min="5" max="25" value="15">
                </div>
                <button onclick="addRecipe()" class="btn-green">Recept ment√©se</button>
            </div>

            <div id="recipes-cook" class="tab-content">
                <div class="form-group">
                    <label>V√°lassz receptet:</label>
                    <select id="cook-recipe-select">
                        <option value="">V√°lassz receptet...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>J√°t√©kos neve:</label>
                    <input type="text" id="cook-player-name" placeholder="J√°t√©kos neve">
                </div>
                <div class="form-group">
                    <label>Skill b√≥nusz:</label>
                    <input type="number" id="cook-skill-bonus" value="0" min="-5" max="10">
                </div>
                <button onclick="startCooking()" class="btn-purple">üé≤ F≈ëz√©s megkezd√©se!</button>
                <div id="cooking-result" class="cooking-simulation" style="display: none;"></div>
            </div>
        </div>

        <!-- Jobb panel: Buff Tracker -->
        <div class="panel">
            <h2>‚ú® Akt√≠v Buffok</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('buffs', 'active')">Akt√≠v</div>
            </div>

            <div id="buffs-active" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="color: #fff;">üïê <span id="current-day">1. nap</span></div>
                    <button onclick="advanceDay()" class="btn-blue">Nap el≈ërehalad√°sa</button>
                </div>
                <div id="active-buffs-container"></div>
            </div>

            <div id="buffs-manage" class="tab-content">
                <div class="form-group">
                    <label>J√°t√©kos:</label>
                    <input type="text" id="manual-buff-player">
                </div>
                <div class="form-group">
                    <label>Buff neve:</label>
                    <input type="text" id="manual-buff-name">
                </div>
                <div class="form-group">
                    <label>Hat√°s:</label>
                    <input type="text" id="manual-buff-effect">
                </div>
                <div class="form-group">
                    <label>H√°tral√©v≈ë napok:</label>
                    <input type="number" id="manual-buff-duration" min="1" max="3" value="1">
                </div>
                <button onclick="addManualBuff()" class="btn-green">Buff hozz√°ad√°sa</button>
                <button onclick="clearExpiredBuffs()" class="btn-orange">Lej√°rt buffok t√∂rl√©se</button>
                <button onclick="clearAllBuffs()" class="btn-destructive">√ñsszes buff t√∂rl√©se</button>
            </div>
        </div>
    </div>

    <script>
        // Glob√°lis v√°ltoz√≥k
        let ingredients = [];
        let recipes = [];
        let activeBuffs = [];
        let currentDay = 1;
        let selectedRecipeIngredients = [];

        // Alap√©rtelmezett adatok
        const defaultIngredients = [
            { id: 1, name: "Vadgomba", rarity: "common", description: "Erd≈ëben tal√°lhat√≥ gomba", quantity: 10 },
            { id: 2, name: "Krist√°lys√≥", rarity: "rare", description: "M√°gikus tulajdons√°gokkal rendelkez≈ë s√≥", quantity: 5 },
            { id: 3, name: "S√°rk√°nygy√∂k√©r", rarity: "legendary", description: "Rendk√≠v√ºl ritka √©s er≈ës gy√≥gyn√∂v√©ny", quantity: 2 },
            { id: 4, name: "Erdei bogy√≥", rarity: "common", description: "√âdes, t√°pl√°l√≥ bogy√≥", quantity: 15 },
            { id: 5, name: "Holdf√©ny vir√°g", rarity: "rare", description: "Csak teliholdkor sz√ºretelhet≈ë", quantity: 3 },
            { id: 6, name: "F≈ënix toll", rarity: "legendary", description: "√öjj√°sz√ºlet√©s erej√©vel b√≠r", quantity: 1 }
        ];

        const defaultRecipes = [
            {
                id: 1,
                name: "Er≈ë italka",
                ingredients: [
                    { ingredientId: 1, quantity: 2 },
                    { ingredientId: 2, quantity: 1 },
                    { ingredientId: 4, quantity: 3 }
                ],
                method: "campfire",
                buff: "+2 Er≈ë",
                duration: 1,
                difficulty: 12
            }
        ];

        // Seg√©df√ºggv√©nyek a sz√°mok kezel√©s√©re
        function safeParseInt(value, defaultValue = 0) {
            const parsed = parseInt(value);
            return isNaN(parsed) ? defaultValue : parsed;
        }

        function ensureNumber(value, defaultValue = 1) {
            if (typeof value === 'number' && !isNaN(value)) {
                return value;
            }
            const parsed = parseInt(value);
            return isNaN(parsed) ? defaultValue : parsed;
        }

        // Inicializ√°l√°s
        function init() {
            loadData();
            if (ingredients.length === 0) {
                ingredients = [...defaultIngredients];
                saveData();
            }
            if (recipes.length === 0) {
                recipes = [...defaultRecipes];
                saveData();
            }
            
            // Biztos√≠tsuk, hogy minden hozz√°val√≥ quantity √©rt√©ke sz√°m
            ingredients = ingredients.map(ing => ({
                ...ing,
                quantity: ensureNumber(ing.quantity, 1)
            }));
            
            updateIngredientsList();
            updateRecipesList();
            updateActiveBuffs();
            updateRecipeSelects();
            updateCurrentDay();
            updateAvailableIngredients();
        }

        // Adatok ment√©se √©s bet√∂lt√©se
        function saveData() {
            localStorage.setItem('fantasyKitchen', JSON.stringify({
                ingredients,
                recipes,
                activeBuffs,
                currentDay
            }));
        }

        function loadData() {
            const data = localStorage.getItem('fantasyKitchen');
            if (data) {
                const parsed = JSON.parse(data);
                ingredients = parsed.ingredients || [];
                recipes = parsed.recipes || [];
                activeBuffs = parsed.activeBuffs || [];
                currentDay = ensureNumber(parsed.currentDay, 1);
            }
        }

        // Tab kezel√©s
        function switchTab(section, tab) {
            // Tab gombok friss√≠t√©se
            const sectionElement = document.querySelector(`#${section}-list`).closest('.panel');
            const tabs = sectionElement.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Tab tartalom friss√≠t√©se
            const contents = sectionElement.querySelectorAll('.tab-content');
            contents.forEach(c => c.classList.remove('active'));
            
            const activeContent = document.getElementById(`${section}-${tab}`);
            if (activeContent) {
                activeContent.classList.add('active');
            }
        }

        // Hozz√°val√≥k kezel√©se
        function addIngredient() {
            const name = document.getElementById('new-ingredient-name').value.trim();
            const rarity = document.getElementById('new-ingredient-rarity').value;
            const description = document.getElementById('new-ingredient-description').value.trim();
            const quantityInput = document.getElementById('new-ingredient-quantity').value;
            const quantity = ensureNumber(quantityInput, 1);

            if (!name) {
                alert('K√©rlek add meg a hozz√°val√≥ nev√©t!');
                return;
            }

            const newIngredient = {
                id: Date.now(),
                name,
                rarity,
                description,
                quantity
            };

            ingredients.push(newIngredient);
            saveData();
            updateIngredientsList();
            updateRecipeSelects();
            updateAvailableIngredients();

            // Form t√∂rl√©se
            document.getElementById('new-ingredient-name').value = '';
            document.getElementById('new-ingredient-description').value = '';
            document.getElementById('new-ingredient-quantity').value = '1';
        }

        function deleteIngredient(id) {
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d ezt a hozz√°val√≥t?')) {
                ingredients = ingredients.filter(ing => ing.id !== id);
                saveData();
                updateIngredientsList();
                updateRecipeSelects();
                updateAvailableIngredients();
            }
        }

        function updateIngredientQuantity(id, change) {
            ingredients = ingredients.map(ing => {
                if (ing.id === id) {
                    const currentQuantity = ensureNumber(ing.quantity, 0);
                    const newQuantity = Math.max(0, currentQuantity + change);
                    return { ...ing, quantity: newQuantity };
                }
                return ing;
            });
            saveData();
            updateIngredientsList();
        }

        function updateIngredientsList() {
            const container = document.getElementById('ingredients-container');
            const searchTerm = document.getElementById('ingredient-search').value.toLowerCase();
            const rarityFilter = document.getElementById('rarity-filter').value;

            let filteredIngredients = ingredients.filter(ing => {
                const matchesSearch = ing.name.toLowerCase().includes(searchTerm);
                const matchesRarity = rarityFilter === 'all' || ing.rarity === rarityFilter;
                return matchesSearch && matchesRarity;
            });

            container.innerHTML = filteredIngredients.map(ing => {
                const quantity = ensureNumber(ing.quantity, 0);
                const rarityText = ing.rarity === 'common' ? 'Gyakori' : ing.rarity === 'rare' ? 'Ritka' : 'Legend√°s';
                
                return `
                    <div class="item">
                        <div>
                            <strong class="rarity-${ing.rarity}">${ing.name}</strong>
                            <span class="badge badge-${ing.rarity}">${rarityText}</span>
                            <span class="badge badge-outline">${quantity} db</span>
                            <div style="font-size: 0.8em; opacity: 0.8;">${ing.description}</div>
                        </div>
                        <div class="quantity-controls">
                            <button onclick="updateIngredientQuantity(${ing.id}, -1)" ${quantity <= 0 ? 'disabled' : ''}>-</button>
                            <button onclick="updateIngredientQuantity(${ing.id}, 1)">+</button>
                            <button onclick="deleteIngredient(${ing.id})" class="btn-destructive">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchIngredients() {
            updateIngredientsList();
        }

        function filterIngredients() {
            updateIngredientsList();
        }

        // Recept hozz√°val√≥k kezel√©se
        function updateAvailableIngredients() {
            const container = document.getElementById('available-ingredients');
            if (!container) return;

            container.innerHTML = `
                <h4 style="color: #fff; margin: 10px 0;">El√©rhet≈ë hozz√°val√≥k:</h4>
                ${ingredients.map(ingredient => {
                    const isInRecipe = selectedRecipeIngredients.some(ri => ri.ingredientId === ingredient.id);
                    const quantity = ensureNumber(ingredient.quantity, 0);
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(139, 69, 19, 0.2); margin: 5px 0; border-radius: 5px;">
                            <div>
                                <span style="color: #e8d5b7;">${ingredient.name}</span>
                                <span class="badge badge-outline">${quantity} db k√©szleten</span>
                            </div>
                            <button onclick="addIngredientToRecipe(${ingredient.id})" ${selectedRecipeIngredients.length >= 5 && !isInRecipe ? 'disabled' : ''}>
                                ${isInRecipe ? '+' : 'Hozz√°ad'}
                            </button>
                        </div>
                    `;
                }).join('')}
            `;

            updateSelectedIngredients();
        }

        function updateSelectedIngredients() {
            const container = document.getElementById('selected-ingredients');
            if (!container) return;

            if (selectedRecipeIngredients.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <h4 style="color: #fff; margin: 10px 0;">Kiv√°lasztott hozz√°val√≥k:</h4>
                ${selectedRecipeIngredients.map(ri => {
                    const ingredient = ingredients.find(ing => ing.id === ri.ingredientId);
                    const quantity = ensureNumber(ri.quantity, 1);
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(139, 69, 19, 0.3); margin: 5px 0; border-radius: 5px;">
                            <span style="color: #e8d5b7;">${ingredient?.name || 'Ismeretlen'} - ${quantity} db</span>
                            <div class="quantity-controls">
                                <input type="number" min="1" value="${quantity}" class="quantity-input" 
                                       onchange="updateRecipeIngredientQuantity(${ri.ingredientId}, this.value)">
                                <button onclick="removeIngredientFromRecipe(${ri.ingredientId})" class="btn-destructive">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function addIngredientToRecipe(ingredientId) {
            if (selectedRecipeIngredients.length >= 5) {
                alert('Maximum 5 hozz√°val√≥ adhat√≥ hozz√°!');
                return;
            }

            const existingIngredient = selectedRecipeIngredients.find(ri => ri.ingredientId === ingredientId);
            if (existingIngredient) {
                existingIngredient.quantity = ensureNumber(existingIngredient.quantity, 0) + 1;
            } else {
                selectedRecipeIngredients.push({ ingredientId, quantity: 1 });
            }

            updateAvailableIngredients();
        }

        function removeIngredientFromRecipe(ingredientId) {
            selectedRecipeIngredients = selectedRecipeIngredients.filter(ri => ri.ingredientId !== ingredientId);
            updateAvailableIngredients();
        }

        function updateRecipeIngredientQuantity(ingredientId, inputValue) {
            const quantity = ensureNumber(inputValue, 1);
            
            if (quantity <= 0) {
                removeIngredientFromRecipe(ingredientId);
                return;
            }

            const ingredient = selectedRecipeIngredients.find(ri => ri.ingredientId === ingredientId);
            if (ingredient) {
                ingredient.quantity = quantity;
            }

            updateSelectedIngredients();
        }

        // Receptek kezel√©se
        function addRecipe() {
            const name = document.getElementById('new-recipe-name').value.trim();
            const method = document.getElementById('new-recipe-method').value;
            const buff = document.getElementById('new-recipe-buff').value.trim();
            const duration = ensureNumber(document.getElementById('new-recipe-duration').value, 1);
            const difficulty = ensureNumber(document.getElementById('new-recipe-difficulty').value, 15);

            if (!name || !buff) {
                alert('K√©rlek t√∂ltsd ki a k√∂telez≈ë mez≈ëket!');
                return;
            }

            const totalIngredientCount = selectedRecipeIngredients.reduce((sum, ingredient) => {
                return sum + ensureNumber(ingredient.quantity, 0);
            }, 0);

            if (totalIngredientCount < 3) {
                alert('Minimum 3 darab hozz√°val√≥ sz√ºks√©ges √∂sszesen!');
                return;
            }

            const newRecipe = {
                id: Date.now(),
                name,
                ingredients: selectedRecipeIngredients.map(ri => ({
                    ingredientId: ri.ingredientId,
                    quantity: ensureNumber(ri.quantity, 1)
                })),
                method,
                buff,
                duration,
                difficulty
            };

            recipes.push(newRecipe);
            saveData();
            updateRecipesList();
            updateRecipeSelects();

            // Form t√∂rl√©se
            document.getElementById('new-recipe-name').value = '';
            document.getElementById('new-recipe-buff').value = '';
            selectedRecipeIngredients = [];
            updateAvailableIngredients();
        }

        function deleteRecipe(id) {
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d ezt a receptet?')) {
                recipes = recipes.filter(recipe => recipe.id !== id);
                saveData();
                updateRecipesList();
                updateRecipeSelects();
            }
        }

        function updateRecipesList() {
            const container = document.getElementById('recipes-container');
            const searchTerm = document.getElementById('recipe-search').value.toLowerCase();

            let filteredRecipes = recipes.filter(recipe => 
                recipe.name.toLowerCase().includes(searchTerm)
            );

            container.innerHTML = filteredRecipes.map(recipe => {
                const ingredientNames = recipe.ingredients
                    .map(ri => {
                        const ingredient = ingredients.find(ing => ing.id === ri.ingredientId);
                        const quantity = ensureNumber(ri.quantity, 1);
                        return ingredient ? `${quantity}x ${ingredient.name}` : `${quantity}x Ismeretlen`;
                    })
                    .join(', ');

                const methodNames = {
                    campfire: 'T√°bori t≈±z',
                    wanderer: 'V√°ndorkonyha',
                    sanctuary: 'Szent√©lykonyha'
                };

                return `
                    <div class="recipe-card">
                        <div class="recipe-title">${recipe.name}</div>
                        <div><strong>Hozz√°val√≥k:</strong> ${ingredientNames}</div>
                        <div><strong>F≈ëz√©si m√≥d:</strong> ${methodNames[recipe.method]}</div>
                        <div><strong>Buff:</strong> ${recipe.buff}</div>
                        <div><strong>Id≈ëtartam:</strong> ${recipe.duration} nap</div>
                        <div><strong>Neh√©zs√©g:</strong> DC ${recipe.difficulty}</div>
                        <button onclick="deleteRecipe(${recipe.id})" class="btn-destructive" style="margin-top: 10px;">T√∂rl√©s</button>
                    </div>
                `;
            }).join('');
        }

        function searchRecipes() {
            updateRecipesList();
        }

        function updateRecipeSelects() {
            const cookSelect = document.getElementById('cook-recipe-select');
            if (cookSelect) {
                const currentValue = cookSelect.value;
                cookSelect.innerHTML = '<option value="">V√°lassz receptet...</option>';
                recipes.forEach(recipe => {
                    cookSelect.innerHTML += `<option value="${recipe.id}" ${currentValue == recipe.id ? 'selected' : ''}>${recipe.name}</option>`;
                });
            }
        }

        // F≈ëz√©s szimul√°ci√≥
        function startCooking() {
            const recipeId = safeParseInt(document.getElementById('cook-recipe-select').value);
            const playerName = document.getElementById('cook-player-name').value.trim();
            const skillBonus = safeParseInt(document.getElementById('cook-skill-bonus').value, 0);

            if (!recipeId || !playerName) {
                alert('K√©rlek v√°lassz receptet √©s add meg a j√°t√©kos nev√©t!');
                return;
            }

            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) {
                alert('Recept nem tal√°lhat√≥!');
                return;
            }

            // Ellen≈ërizd, hogy van-e el√©g hozz√°val√≥
            const hasEnoughIngredients = recipe.ingredients.every(recipeIngredient => {
                const ingredient = ingredients.find(ing => ing.id === recipeIngredient.ingredientId);
                const ingredientQuantity = ensureNumber(ingredient?.quantity, 0);
                const requiredQuantity = ensureNumber(recipeIngredient.quantity, 1);
                return ingredientQuantity >= requiredQuantity;
            });

            if (!hasEnoughIngredients) {
                alert('Nincs el√©g hozz√°val√≥ a recepthez!');
                return;
            }

            // Dob√°s (d20 + skill b√≥nusz)
            const roll = Math.floor(Math.random() * 20) + 1;
            const total = roll + skillBonus;
            const dc = recipe.difficulty;

            const resultContainer = document.getElementById('cooking-result');
            resultContainer.style.display = 'block';

            let resultClass = '';
            let resultText = '';
            let success = false;
            let buffDuration = recipe.duration;

            if (roll === 20) {
                // Kritikus siker
                resultClass = 'critical success';
                resultText = 'KRITIKUS SIKER!';
                success = true;
                buffDuration *= 2;
                addBuff(playerName, recipe.name, recipe.buff, buffDuration);
            } else if (roll === 1) {
                // Kritikus kudarc
                resultClass = 'critical failure';
                resultText = 'KRITIKUS KUDARC!';
                const negativeEffects = [
                    'M√©rgez√©s - 1 nap',
                    'Gyenges√©g - 1 nap',
                    'H√°nyinger - 1 nap'
                ];
                const randomEffect = negativeEffects[Math.floor(Math.random() * negativeEffects.length)];
                addBuff(playerName, 'F√©lresiker√ºlt f≈ëz√©s', randomEffect, 1);
            } else if (total >= dc) {
                // Norm√°l siker
                resultClass = 'success';
                resultText = 'SIKER!';
                success = true;
                addBuff(playerName, recipe.name, recipe.buff, buffDuration);
            } else {
                // Kudarc
                resultClass = 'failure';
                resultText = 'KUDARC!';
            }

            // Sikeres f≈ëz√©s eset√©n cs√∂kkentsd a hozz√°val√≥k mennyis√©g√©t
            if (success && resultClass !== 'critical failure') {
                ingredients = ingredients.map(ingredient => {
                    const recipeIngredient = recipe.ingredients.find(ri => ri.ingredientId === ingredient.id);
                    if (recipeIngredient) {
                        const currentQuantity = ensureNumber(ingredient.quantity, 0);
                        const usedQuantity = ensureNumber(recipeIngredient.quantity, 0);
                        return { ...ingredient, quantity: Math.max(0, currentQuantity - usedQuantity) };
                    }
                    return ingredient;
                });
                saveData();
                updateIngredientsList();
            }

            resultContainer.innerHTML = `
                <h3>F≈ëz√©s eredm√©nye</h3>
                <div class="dice-result ${resultClass}">üé≤ ${roll} + ${skillBonus} = ${total}</div>
                <div class="dice-result ${resultClass}">${resultText}</div>
                <div>C√©l neh√©zs√©g: ${dc}</div>
                ${success ? `<div style="color: #00ff00;">Buff aktiv√°lva: ${recipe.buff}</div>` : ''}
            `;

            updateActiveBuffs();
            saveData();
        }

        // Buff kezel√©s
        function addBuff(playerName, buffName, effect, duration) {
            const newBuff = {
                id: Date.now(),
                player: playerName,
                name: buffName,
                effect: effect,
                duration: ensureNumber(duration, 1),
                startDay: currentDay
            };

            activeBuffs.push(newBuff);
            saveData();
        }

        function addManualBuff() {
            const player = document.getElementById('manual-buff-player').value.trim();
            const name = document.getElementById('manual-buff-name').value.trim();
            const effect = document.getElementById('manual-buff-effect').value.trim();
            const duration = ensureNumber(document.getElementById('manual-buff-duration').value, 1);

            if (!player || !name || !effect) {
                alert('K√©rlek t√∂ltsd ki az √∂sszes mez≈ët!');
                return;
            }

            addBuff(player, name, effect, duration);
            updateActiveBuffs();

            // Form t√∂rl√©se
            document.getElementById('manual-buff-player').value = '';
            document.getElementById('manual-buff-name').value = '';
            document.getElementById('manual-buff-effect').value = '';
            document.getElementById('manual-buff-duration').value = '1';
        }

        function removeBuff(id) {
            activeBuffs = activeBuffs.filter(buff => buff.id !== id);
            saveData();
            updateActiveBuffs();
        }

        function advanceDay() {
            currentDay++;
            
            // Buff id≈ëtartamok cs√∂kkent√©se
            activeBuffs.forEach(buff => {
                buff.duration = ensureNumber(buff.duration, 1) - 1;
            });

            // Lej√°rt buffok automatikus t√∂rl√©se
            activeBuffs = activeBuffs.filter(buff => ensureNumber(buff.duration, 0) > 0);

            saveData();
            updateActiveBuffs();
            updateCurrentDay();
        }

        function clearExpiredBuffs() {
            activeBuffs = activeBuffs.filter(buff => ensureNumber(buff.duration, 0) > 0);
            saveData();
            updateActiveBuffs();
        }

        function clearAllBuffs() {
            if (confirm('Biztosan t√∂r√∂lni szeretn√©d az √∂sszes buffot?')) {
                activeBuffs = [];
                saveData();
                updateActiveBuffs();
            }
        }

        function updateActiveBuffs() {
            const container = document.getElementById('active-buffs-container');
            
            if (activeBuffs.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.6;">Nincsenek akt√≠v buffok</div>';
                return;
            }

            // J√°t√©kosok szerint csoportos√≠t√°s
            const playerBuffs = {};
            activeBuffs.forEach(buff => {
                if (!playerBuffs[buff.player]) {
                    playerBuffs[buff.player] = [];
                }
                playerBuffs[buff.player].push(buff);
            });

            container.innerHTML = Object.entries(playerBuffs).map(([player, buffs]) => `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #fff; border-bottom: 1px solid #80b3ff; padding-bottom: 5px;">üë• ${player}</h4>
                    ${buffs.map(buff => {
                        const duration = ensureNumber(buff.duration, 0);
                        return `
                            <div class="buff-card ${duration <= 0 ? 'buff-expired' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${buff.name}</strong><br>
                                        <span style="font-size: 0.9em;">${buff.effect}</span><br>
                                        <span style="font-size: 0.8em; opacity: 0.8;">
                                            ${duration > 0 ? `${duration} nap h√°tra` : 'LEJ√ÅRT'}
                                        </span>
                                    </div>
                                    <button onclick="removeBuff(${buff.id})" class="btn-destructive">√ó</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }

        function updateCurrentDay() {
            document.getElementById('current-day').textContent = `${currentDay}. nap`;
        }

        // Inicializ√°l√°s az oldal bet√∂lt√©sekor
        window.onload = init;
    </script>
</body>
</html>